<?php
session_start();
// Security check: ensure only logged-in orphanages can access this
if (!isset($_SESSION['orphanage_id'])) {
    header("Location: login.php");
    exit();
}

$conn = mysqli_connect("localhost", "root", "", "donation_db");
$oid = $_SESSION['orphanage_id'];

// 1. Fetch total donations received by this specific orphanage
$total_sql = "SELECT SUM(amount) as total FROM donations WHERE orphanage_id = $oid";
$total_res = mysqli_query($conn, $total_sql);
$total_data = mysqli_fetch_assoc($total_res);
$total_amount = $total_data['total'] ?? 0;

// 2. Fetch current profile details to pre-fill the form
$sql = "SELECT * FROM orphanages WHERE id = $oid";
$res = mysqli_query($conn, $sql);
$orphanage = mysqli_fetch_assoc($res);
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Orphanage - CHARITECH</title>
    <style>
        :root {
            --bg-color: #fcfcfc;
            --primary-dark: #0f172a;
            --accent-blue: #2563eb;
            --accent-green: #22c55e;
            --border-heavy: #1e293b;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0; background-color: var(--bg-color);
            color: #334155; line-height: 1.6;
        }

        header {
            text-align: center; padding: 40px 20px; background: #fff;
            border-bottom: 3px solid var(--primary-dark);
        }
        header h1 { font-size: 42px; color: var(--primary-dark); margin: 0; font-weight: 900; text-transform: uppercase; }

        nav { text-align: center; padding: 15px; background: var(--primary-dark); }
        nav a { color: #fff; text-decoration: none; margin: 0 20px; font-weight: 700; text-transform: uppercase; }

        .container { max-width: 800px; margin: 40px auto; padding: 0 20px; }

        /* Stats Card - Consistent with Donor Dashboard */
        .stats-hero {
            background-color: var(--aim-bg, #dcfce7);
            border: 2px solid var(--aim-border, #22c55e);
            padding: 30px; border-radius: 12px; text-align: center;
            margin-bottom: 30px; box-shadow: 8px 8px 0px rgba(15, 23, 42, 0.1);
        }
        .stats-hero h2 { margin: 0; color: var(--primary-dark); font-size: 24px; }
        .total-val { font-size: 48px; font-weight: 900; color: var(--accent-green); }

        /* Management Form - Consistent with Signup Style */
        .manage-card {
            background: #fff; border: 3px solid var(--primary-dark);
            padding: 40px; border-radius: 12px;
            box-shadow: 10px 10px 0px rgba(15, 23, 42, 0.1);
        }
        .manage-card h3 { margin-top: 0; color: var(--primary-dark); text-transform: uppercase; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        label { display: block; font-weight: 700; margin: 15px 0 5px; color: var(--primary-dark); }
        input[type="text"], input[type="number"], input[type="file"] {
            width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 6px; box-sizing: border-box;
        }

        .btn-save {
            width: 100%; background-color: var(--primary-dark); color: white;
            padding: 16px; border: none; border-radius: 6px; font-weight: 800;
            font-size: 18px; cursor: pointer; text-transform: uppercase; margin-top: 25px; transition: 0.3s;
        }
        .btn-save:hover { background-color: var(--accent-blue); transform: translateY(-2px); }

        .current-img { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; margin-top: 10px; border: 1px solid #ddd; }
    </style>
</head>
<body>

<header><h1>Management Panel</h1></header>
<nav>
    <a href="orphanage_dashboard.php">My Profile</a> 
    <a href="logout.php">Logout</a>
</nav>

<div class="container">
    <div class="stats-hero">
        <h2>Total Contributions Received</h2>
        <div class="total-val">â‚¹<?php echo number_format($total_amount, 2); ?></div>
        <p>Thank you for the wonderful work you do for the children!</p>
    </div>

    <div class="manage-card">
        <h3>Update Orphanage Details</h3>
        <form action="update_orphanage_process.php" method="POST" enctype="multipart/form-data">
            <label>Orphanage Name:</label>
            <input type="text" name="name" value="<?php echo htmlspecialchars($orphanage['name']); ?>" required>

            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <label>No. of Children:</label>
                    <input type="number" name="children_count" value="<?php echo $orphanage['children_count']; ?>" required>
                </div>
                <div style="flex: 1;">
                    <label>Age Group:</label>
                    <input type="text" name="age_group" value="<?php echo htmlspecialchars($orphanage['age_group']); ?>" required>
                </div>
            </div>

            <label>Update Profile Photo:</label>
            <?php if(!empty($orphanage['orphanage_image'])): ?>
                <img src="<?php echo $orphanage['orphanage_image']; ?>" class="current-img"><br>
            <?php endif; ?>
            <input type="file" name="orphanage_image" accept="image/*">

            <button type="submit" class="btn-save">Save Changes</button>
        </form>
    </div>
</div>

</body>
</html>